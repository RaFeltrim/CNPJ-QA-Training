name: CNPJ Validator CI/CD - Shift Left Testing

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  schedule:
    # Executar testes diariamente às 2h da manhã
    - cron: '0 2 * * *'

jobs:
  # ============================================================================
  # FASE 1: QUALITY CHECKS (Shift Left - Verificações Rápidas)
  # ============================================================================
  quality-checks:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint black bandit safety
    
    - name: Verificar formatação (Black)
      run: |
        black --check src/cnpj_validator/
    
    - name: Linting (Flake8)
      run: |
        flake8 src/cnpj_validator/ --max-line-length=100 --statistics
    
    - name: Análise estática (Pylint)
      run: |
        pylint src/cnpj_validator/ --fail-under=8.0
      continue-on-error: true
    
    - name: Security scan (Bandit)
      run: |
        bandit -r src/cnpj_validator/ -f json -o bandit-report.json
      continue-on-error: true
    
    - name: Verificar vulnerabilidades (Safety)
      run: |
        safety check --json
      continue-on-error: true

  # ============================================================================
  # FASE 2: UNIT TESTS (Shift Left - Testes Rápidos e Isolados)
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ${{ matrix.os }}
    needs: quality-checks
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Executar testes unitários
      run: |
        pytest tests/ -v -m "unit or not integration" --tb=short --maxfail=5
    
    - name: Upload resultados
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: unit-test-results-${{ matrix.os }}-py${{ matrix.python-version }}
        path: reports/

  # ============================================================================
  # FASE 3: INTEGRATION TESTS (Shift Left - Testes de Integração)
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Executar testes de integração
      run: |
        pytest tests/test_integration.py -v -m integration --tb=short
    
    - name: Upload resultados
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: integration-test-results
        path: reports/

  # ============================================================================
  # FASE 4: COVERAGE & REPORTING (Shift Left - Métricas de Qualidade)
  # ============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Executar testes com cobertura
      run: |
        pytest --cov=src/cnpj_validator --cov-report=xml --cov-report=html --cov-report=term-missing --cov-fail-under=80
    
    - name: Upload cobertura para Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Upload relatório de cobertura
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: reports/coverage/

  # ============================================================================
  # FASE 5: SMOKE TESTS (Shift Left - Testes Críticos)
  # ============================================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: quality-checks
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Executar smoke tests
      run: |
        pytest -v -m smoke --tb=line
    
    - name: Testar exemplo básico
      run: |
        python examples/simple_example.py

  # ============================================================================
  # FASE 6: REGRESSION TESTS (Shift Left - Prevenção de Regressões)
  # ============================================================================
  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Executar testes de regressão
      run: |
        pytest -v -m regression --tb=short

  # ============================================================================
  # FASE 7: ZEPHYR INTEGRATION (Opcional - Sincronizar com Jira)
  # ============================================================================
  sync-zephyr:
    name: Sync Results to Zephyr
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Download resultados de testes
      uses: actions/download-artifact@v3
    
    - name: Sincronizar com Zephyr Scale
      run: |
        echo "Sincronizando resultados com Zephyr Scale..."
        # Implementar script de sincronização aqui
        # python scripts/sync_to_zephyr.py
      env:
        ZEPHYR_API_TOKEN: ${{ secrets.ZEPHYR_API_TOKEN }}
        JIRA_PROJECT_KEY: CNPJ

  # ============================================================================
  # FASE 8: NOTIFICATIONS (Alertas de Qualidade)
  # ============================================================================
  notify:
    name: Notificar Resultados
    runs-on: ubuntu-latest
    needs: [quality-checks, unit-tests, integration-tests, coverage]
    if: always()
    
    steps:
    - name: Verificar status dos jobs
      run: |
        echo "Quality Checks: ${{ needs.quality-checks.result }}"
        echo "Unit Tests: ${{ needs.unit-tests.result }}"
        echo "Integration Tests: ${{ needs.integration-tests.result }}"
        echo "Coverage: ${{ needs.coverage.result }}"
    
    # Adicionar notificações (Slack, Email, etc)
    # - name: Notificar Slack
    #   uses: 8398a7/action-slack@v3
    #   with:
    #     status: ${{ job.status }}
    #     channel: '#cnpj-qa'
